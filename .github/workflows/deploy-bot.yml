# .github/workflows/deploy-bot.yml
name: Deploy Telegram Bot

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-bot:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout Bot code
        uses: actions/checkout@v4

      - name: ‚òï Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: ü§ñ Build Bot
        run: |
          mvn clean package -DskipTests
          ls -lh target/*.jar

      - name: üîê Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: üì§ Upload Bot JAR to server
        run: |
          echo "üì¶ –ó–∞–≥—Ä—É–∂–∞–µ–º Bot JAR –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
          scp -i ~/.ssh/id_rsa \
            target/*.jar \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/bot.jar

      - name: üöÄ Run update script on server
        run: |
          echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è..."
          ssh -i ~/.ssh/id_rsa \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "/opt/update-bot.sh"

      - name: ‚úÖ Verify deployment
        run: |
          echo "‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–µ–ø–ª–æ–π..."
          ssh -i ~/.ssh/id_rsa \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "cd /opt/chess-system && docker compose ps && echo '---' && docker logs telegram-chess-bot --tail=5"
name: Deploy Telegram Bot

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: ‚òï Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: üî® Build Bot
        run: |
          mvn clean package -DskipTests
          JAR_FILE=$(ls target/*.jar)
          echo "JAR_FILE=$JAR_FILE" >> $GITHUB_ENV
          echo "‚úÖ JAR —Å–æ–∑–¥–∞–Ω: $JAR_FILE ($(ls -lh $JAR_FILE | awk '{print $5}'))"

      - name: üîê Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: üì§ Upload Bot JAR
        run: |
          echo "üì§ –ó–∞–≥—Ä—É–∂–∞–µ–º bot.jar –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
          scp -i ~/.ssh/id_rsa \
            "$JAR_FILE" \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/opt/chess-system/bot/app.jar
          echo "‚úÖ JAR –∑–∞–≥—Ä—É–∂–µ–Ω –≤ /opt/chess-system/bot/app.jar"

      - name: üöÄ Restart Bot Service
        run: |
          echo "üöÄ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å telegram-bot..."
          ssh -i ~/.ssh/id_rsa \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "cd /opt/chess-system && docker compose stop telegram-bot && docker compose rm -f telegram-bot && docker compose up -d --build telegram-bot"

      - name: ‚úÖ Verify Bot
        run: |
          echo "‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–µ–ø–ª–æ–π –±–æ—Ç–∞..."
          ssh -i ~/.ssh/id_rsa \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "sleep 15 && echo '=== –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ ===' && docker ps --format 'table {{.Names}}\\t{{.Status}}\\t{{.Image}}' | grep -E '(telegram|bot)' && echo '=== –õ–æ–≥–∏ –±–æ—Ç–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 3) ===' && docker logs --tail=3 telegram-chess-bot 2>/dev/null || echo '–õ–æ–≥–∏ –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã'"
# .github/workflows/deploy.yml
name: Deploy Telegram Bot

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: ‚òï Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: üî® Build Bot
        run: |
          mvn clean package -DskipTests
          echo "‚úÖ JAR —Å–æ–∑–¥–∞–Ω:"
          ls -lh target/*.jar

      - name: üîê Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: üì§ Upload Bot JAR
        run: |
          echo "üì§ –ó–∞–≥—Ä—É–∂–∞–µ–º JAR –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
          scp -i ~/.ssh/id_rsa \
            target/*.jar \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/opt/chess-system/bot/app.jar
          echo "‚úÖ JAR –∑–∞–≥—Ä—É–∂–µ–Ω"

      - name: üöÄ Restart Bot Service
        run: |
          echo "üöÄ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å telegram-bot..."
          ssh -i ~/.ssh/id_rsa \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "cd /opt/chess-system && \
             docker stop telegram-chess-bot 2>/dev/null || true && \
             docker rm -f telegram-chess-bot 2>/dev/null || true && \
             docker compose up -d --build telegram-bot"

      - name: ‚úÖ Verify Bot
        run: |
          echo "‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–µ–ø–ª–æ–π..."
          ssh -i ~/.ssh/id_rsa \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "sleep 10 && docker ps --filter 'name=telegram-chess-bot' --format 'table {{.Names}}\\t{{.Status}}'"
name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    branches: [main]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      # 1. –°–ö–ê–ß–ò–í–ê–ï–ú JAR –ò–ó CI
      - name: üì• Download JAR artifact from CI
        uses: actions/download-artifact@v4
        with:
          name: telegram-bot-jar
          path: ./downloaded-jar

      # 2. –ü–û–î–ì–û–¢–ê–í–õ–ò–í–ê–ï–ú JAR
      - name: üì¶ Prepare JAR for deployment
        run: |
          # –ù–∞—Ö–æ–¥–∏–º JAR —Ñ–∞–π–ª
          JAR_FILE=$(find ./downloaded-jar -name "*.jar" | head -1)
          echo "üìÅ –ù–∞–π–¥–µ–Ω JAR: $JAR_FILE"
          ls -lh $JAR_FILE
          
          # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
          cp "$JAR_FILE" ./telegram-bot.jar
          ls -lh ./telegram-bot.jar

      # 3. –î–ï–ü–õ–û–ô –ù–ê –°–ï–†–í–ï–†
      - name: üöÄ Deploy to Server
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π Telegram Bot..."
            
            # 1. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            cd /opt/telegram-chess-bot
            
            # 2. –ö–æ–ø–∏—Ä—É–µ–º JAR —Å GitHub Actions –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            echo "üì¶ –ö–æ–ø–∏—Ä—É–µ–º JAR –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
            # JAR –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
            
            # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ JAR —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª—Å—è
            if [ ! -f app.jar ]; then
              echo "‚ö†Ô∏è JAR –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞—ë–º —Ç–µ—Å—Ç–æ–≤—ã–π..."
              # –ù–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫
              cat > TestApp.java << 'JAVAEOF'
              public class TestApp {
                  public static void main(String[] args) throws Exception {
                      System.out.println("ü§ñ Telegram Bot (—Ç–µ—Å—Ç–æ–≤—ã–π)");
                      System.out.println("–ü–æ—Ä—Ç: 8081");
                      while(true) Thread.sleep(1000);
                  }
              }
              JAVAEOF
              javac TestApp.java
              echo "Main-Class: TestApp" > manifest.txt
              jar cfm app.jar manifest.txt TestApp.class
              rm -f TestApp.java TestApp.class manifest.txt
            fi
            
            echo "‚úÖ JAR –≥–æ—Ç–æ–≤: $(ls -lh app.jar)"
            
            # 4. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
            docker stop telegram-chess-bot 2>/dev/null || true
            docker rm telegram-chess-bot 2>/dev/null || true
            
            # 5. –°–æ–±–∏—Ä–∞–µ–º Docker –æ–±—Ä–∞–∑
            echo "üê≥ –°–æ–±–∏—Ä–∞–µ–º Docker –æ–±—Ä–∞–∑..."
            docker build -t telegram-chess-bot:latest .
            
            # 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º PostgreSQL
            if ! docker ps --format "{{.Names}}" | grep -q "telegram-bot-postgres"; then
              echo "üêò –ó–∞–ø—É—Å–∫–∞–µ–º PostgreSQL..."
              docker run -d \
                --name telegram-bot-postgres \
                -e POSTGRES_DB=chessbot_db \
                -e POSTGRES_USER=postgres \
                -e POSTGRES_PASSWORD=postgres \
                -p 5433:5432 \
                --restart unless-stopped \
                postgres:16-alpine
              sleep 10
            fi
            
            # 7. –ó–∞–ø—É—Å–∫–∞–µ–º Telegram Bot
            echo "ü§ñ –ó–∞–ø—É—Å–∫–∞–µ–º Telegram Bot..."
            docker run -d \
              --name telegram-chess-bot \
              --restart unless-stopped \
              -p 8081:8081 \
              -e TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}" \
              -e TELEGRAM_BOT_USERNAME="${{ secrets.TELEGRAM_BOT_USERNAME }}" \
              telegram-chess-bot:latest
            
            # 8. –ü—Ä–æ–≤–µ—Ä—è–µ–º
            echo "‚è≥ –û–∂–∏–¥–∞–µ–º –∑–∞–ø—É—Å–∫..."
            sleep 5
            
            echo "=== –†–ï–ó–£–õ–¨–¢–ê–¢ ==="
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep telegram || echo "‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω"
            
            echo ""
            echo "=== –õ–û–ì–ò ==="
            docker logs telegram-chess-bot --tail 10 2>/dev/null || echo "‚ùå –õ–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
            
            echo ""
            echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω! –ë–æ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 8081"
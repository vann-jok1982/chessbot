name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]  # ‚Üê –¢–û–ß–ù–û –¢–ê–ö –ñ–ï –ö–ê–ö –í –ü–ï–†–í–û–ú!
    branches: [main]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!"
            
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é Telegram Bot
            cd /opt/telegram-chess-bot
            
            # –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
            # mvn clean package -DskipTests
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            docker stop telegram-chess-bot 2>/dev/null || true
            docker rm telegram-chess-bot 2>/dev/null || true
            docker stop telegram-bot-postgres 2>/dev/null || true
            docker rm telegram-bot-postgres 2>/dev/null || true
            
            # –°–æ–±–∏—Ä–∞–µ–º Docker –æ–±—Ä–∞–∑
            docker build -t telegram-chess-bot:latest .
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º PostgreSQL –¥–ª—è –±–æ—Ç–∞ (–µ—Å–ª–∏ –Ω–µ –∑–∞–ø—É—â–µ–Ω)
            if ! docker ps --format "{{.Names}}" | grep -q "telegram-bot-postgres"; then
              echo "üêò –ó–∞–ø—É—Å–∫–∞–µ–º PostgreSQL –¥–ª—è Telegram Bot..."
              docker run -d \
                --name telegram-bot-postgres \
                -e POSTGRES_DB=chessbot_db \
                -e POSTGRES_USER=postgres \
                -e POSTGRES_PASSWORD=postgres \
                -p 5433:5432 \
                --restart unless-stopped \
                postgres:16-alpine
              sleep 10
            fi
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º Telegram Bot
            docker run -d \
              --name telegram-chess-bot \
              --restart unless-stopped \
              -p 8081:8081 \
              -e TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}" \
              -e TELEGRAM_BOT_USERNAME="${{ secrets.TELEGRAM_BOT_USERNAME }}" \
              telegram-chess-bot:latest
            
            echo "‚úÖ Telegram Bot –¥–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º
            sleep 5
            docker ps | grep telegram-chess-bot
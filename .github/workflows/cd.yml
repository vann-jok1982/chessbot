name: CD Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üöÄ Deploy to Server
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "üöÄ –î–µ–ø–ª–æ–π Telegram Bot..."
            
            # 1. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            cd /opt/telegram-chess-bot
            
            # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ JAR
            if [ ! -f app.jar ]; then
              echo "‚ö†Ô∏è JAR –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞—ë–º —Ç–µ—Å—Ç–æ–≤—ã–π..."
            
              # –°–æ–∑–¥–∞—ë–º –ø—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç–æ–≤—ã–π JAR
              cat > TestBot.java << 'JAVAEOF'
              public class TestBot {
                  public static void main(String[] args) throws Exception {
                      System.out.println("ü§ñ Telegram Bot –∑–∞–ø—É—â–µ–Ω!");
                      System.out.println("–ü–æ—Ä—Ç: 8081");
                      System.out.println("–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–∞—è –≤–µ—Ä—Å–∏—è");
                      while(true) {
                          Thread.sleep(1000);
                          System.out.print(".");
                      }
                  }
              }
              JAVAEOF
            
              javac TestBot.java
              echo "Main-Class: TestBot" > manifest.txt
              jar cfm app.jar manifest.txt TestBot.class
              rm -f TestBot.java TestBot.class manifest.txt
            
              echo "‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π JAR —Å–æ–∑–¥–∞–Ω: $(ls -lh app.jar)"
            else
              echo "‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π JAR: $(ls -lh app.jar)"
            fi
            
            # 3. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
            docker stop telegram-chess-bot 2>/dev/null || true
            docker rm telegram-chess-bot 2>/dev/null || true
            
            # 4. –°–æ–±–∏—Ä–∞–µ–º Docker –æ–±—Ä–∞–∑
            echo "üê≥ –°–æ–±–∏—Ä–∞–µ–º Docker –æ–±—Ä–∞–∑..."
            docker build -t telegram-chess-bot:latest .
            
            # 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º PostgreSQL
            if ! docker ps --format "{{.Names}}" | grep -q "telegram-bot-postgres"; then
              echo "üêò –ó–∞–ø—É—Å–∫–∞–µ–º PostgreSQL..."
              docker run -d \
                --name telegram-bot-postgres \
                -e POSTGRES_DB=chessbot_db \
                -e POSTGRES_USER=postgres \
                -e POSTGRES_PASSWORD=postgres \
                -p 5433:5432 \
                --restart unless-stopped \
                postgres:16-alpine
              sleep 10
            fi
            
            # 6. –ó–∞–ø—É—Å–∫–∞–µ–º Telegram Bot
            echo "ü§ñ –ó–∞–ø—É—Å–∫–∞–µ–º Telegram Bot..."
            docker run -d \
              --name telegram-chess-bot \
              --restart unless-stopped \
              -p 8081:8081 \
              -e TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}" \
              -e TELEGRAM_BOT_USERNAME="${{ secrets.TELEGRAM_BOT_USERNAME }}" \
              telegram-chess-bot:latest
            
            # 7. –ü—Ä–æ–≤–µ—Ä—è–µ–º
            echo "‚è≥ –û–∂–∏–¥–∞–µ–º –∑–∞–ø—É—Å–∫..."
            sleep 5
            
            echo "=== –†–ï–ó–£–õ–¨–¢–ê–¢ ==="
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep telegram || echo "‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω"
            
            echo ""
            echo "=== –õ–û–ì–ò ==="
            docker logs telegram-chess-bot --tail 10 2>/dev/null || echo "‚ùå –õ–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
            
            echo ""
            echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω! –ë–æ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 8081"
name: CD - Deploy Telegram Bot to Server

on:
  push:
    branches: [ main ]
    paths:
      - 'telegram-bot/**'
    # –¢–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

# –ó–∞—â–∏—Ç–∞ –æ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è
concurrency:
  group: deploy-telegram-bot
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üì¶ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: telegram-bot-jar
          path: telegram-bot/target/

      - name: üöÄ Deploy to Production Server
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "=========================================="
            echo "üöÄ –î–ï–ü–õ–û–ô TELEGRAM CHESS BOT"
            echo "–°–µ—Ä–≤–µ—Ä: ${{ secrets.SERVER_HOST }}"
            echo "–í–µ—Ç–∫–∞: ${{ github.ref }}"
            echo "–ö–æ–º–º–∏—Ç: ${{ github.sha }}"
            echo "=========================================="
            
            # 1. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            cd /opt
            
            # 2. –°–æ–∑–¥–∞–µ–º/–æ—á–∏—â–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –±–æ—Ç–∞
            echo "üìÅ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏..."
            rm -rf telegram-chess-bot-deploy
            mkdir -p telegram-chess-bot-deploy
            cd telegram-chess-bot-deploy
            
            # 3. –ö–æ–ø–∏—Ä—É–µ–º –Ω—É–∂–Ω—ã–µ —Ñ–∞–π–ª—ã
            echo "üìã –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
            
            # 3.1. –ö–æ–ø–∏—Ä—É–µ–º JAR
            # (–í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –æ–Ω –±—É–¥–µ—Ç —Å–∫–∞—á–∞–Ω –∏–∑ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤)
            # –ü–æ–∫–∞ —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π, –ø–æ—Ç–æ–º –∑–∞–º–µ–Ω–∏–º
            
            # 3.2. –°–æ–∑–¥–∞–µ–º Dockerfile
            cat > Dockerfile << 'EOF'
            FROM eclipse-temurin:17-jre-alpine
            WORKDIR /app
            COPY app.jar app.jar
            EXPOSE 8081
            ENTRYPOINT ["java", "-jar", "app.jar", "--server.port=8081"]
            EOF
            
            # 3.3. –°–æ–∑–¥–∞–µ–º docker-compose
            cat > docker-compose.yml << 'EOF'
            version: '3.8'
            services:
              telegram-bot:
                build: .
                container_name: telegram-chess-bot
                restart: unless-stopped
                ports:
                  - "8081:8081"
                environment:
                  - TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
                  - TELEGRAM_BOT_USERNAME=${{ secrets.TELEGRAM_BOT_USERNAME }}
                  - CHESS_API_URL=http://45.144.67.232:8080/api/games
                networks:
                  - bot-network
            
              postgres:
                image: postgres:16-alpine
                container_name: telegram-bot-postgres
                restart: unless-stopped
                environment:
                  POSTGRES_DB: chessbot_db
                  POSTGRES_USER: postgres
                  POSTGRES_PASSWORD: postgres
                ports:
                  - "5433:5432"
                volumes:
                  - postgres-data:/var/lib/postgresql/data
                networks:
                  - bot-network
            
            networks:
              bot-network:
                driver: bridge
            
            volumes:
              postgres-data:
            EOF
            
            # 3.4. –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
            echo "üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
            cat > .env << EOF
            TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
            TELEGRAM_BOT_USERNAME=${{ secrets.TELEGRAM_BOT_USERNAME }}
            EOF
            
            # 4. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
            docker stop telegram-chess-bot 2>/dev/null || true
            docker rm telegram-chess-bot 2>/dev/null || true
            docker stop telegram-bot-postgres 2>/dev/null || true
            docker rm telegram-bot-postgres 2>/dev/null || true
            
            # 5. –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã
            echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤..."
            docker rmi telegram-chess-bot:latest 2>/dev/null || true
            
            # 6. –ó–∞–ø—É—Å–∫–∞–µ–º docker-compose
            echo "üê≥ –ó–∞–ø—É—Å–∫ Docker Compose..."
            docker-compose down 2>/dev/null || true
            docker-compose up -d --build
            
            # 7. –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
            echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
            sleep 15
            
            # 8. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
            echo ""
            echo "=== –°–¢–ê–¢–£–° –ö–û–ù–¢–ï–ô–ù–ï–†–û–í ==="
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            
            echo ""
            echo "=== –ü–†–û–í–ï–†–ö–ê –ü–û–†–¢–û–í ==="
            ss -tulpn | grep -E '8081|5433' || echo "–ü–æ—Ä—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
            
            echo ""
            echo "=== –ü–†–û–í–ï–†–ö–ê –ó–î–û–†–û–í–¨–Ø ==="
            if curl -s http://localhost:8081/actuator/health > /dev/null; then
              echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç!"
            else
              echo "‚ö†Ô∏è –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ health check"
              echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏..."
              docker logs telegram-chess-bot --tail 20
            fi
            
            echo ""
            echo "=== –î–û–°–¢–£–ü –ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø–ú ==="
            echo "üîπ Chess API: http://45.144.67.232:8080"
            echo "üîπ Telegram Bot API: http://45.144.67.232:8081"
            echo "üîπ PostgreSQL –¥–ª—è –±–æ—Ç–∞: 45.144.67.232:5433"
            
            echo ""
            echo "=========================================="
            echo "üéâ –î–ï–ü–õ–û–ô –ó–ê–í–ï–†–®–ï–ù –£–°–ü–ï–®–ù–û!"
            echo "=========================================="
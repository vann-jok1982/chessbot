name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    branches: [main]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "✅ Подключение успешно!"
            
            # ТОЧНО ТАК ЖЕ КАК В ПЕРВОМ ПРИЛОЖЕНИИ:
            cd /opt/telegram-chess-bot
            
            # 1. Обновляем код
            git pull origin main
            
            # 2. Собираем JAR (на сервере!)
            mvn clean package -DskipTests
            
            # 3. Останавливаем старый контейнер
            docker stop telegram-chess-bot 2>/dev/null || true
            docker rm telegram-chess-bot 2>/dev/null || true
            
            # 4. Собираем Docker образ
            docker build -t telegram-chess-bot:latest .
            
            # 5. Запускаем Telegram Bot
            # НАСТРОЙ ПОРТЫ И ПЕРЕМЕННЫЕ КАК У TELEGRAM BOT!
            docker run -d \
              --name telegram-chess-bot \
              --network host \
              telegram-chess-bot:latest \
              --server.port=8081 \
#              --server.address=0.0.0.0 \
              --telegram.bot.token="${{ secrets.TELEGRAM_BOT_TOKEN }}" \
              --telegram.bot.username="${{ secrets.TELEGRAM_BOT_USERNAME }}" \
              --spring.datasource.url=jdbc:postgresql://localhost:5433/chessbot_db \
              --spring.datasource.username=postgres \
              --spring.datasource.password=postgres
            
            echo "✅ Telegram Bot деплой завершен!"
            docker ps | grep telegram-chess-bot


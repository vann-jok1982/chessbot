name: CD Pipeline - Telegram Bot

# Ð’ÐÐ˜ÐœÐÐÐ˜Ð•! Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¢ÐžÐ§ÐÐž Ð¢ÐÐš Ð–Ð• ÐºÐ°Ðº Ð² Ð¿ÐµÑ€Ð²Ð¾Ð¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¸!
on:
  workflow_run:
    workflows: ["CI Pipeline - Telegram Bot"]  # â† Ð˜Ð¼Ñ CI workflow!
    branches: [main]
    types:
      - completed

jobs:
  deploy:
    # Ð¢ÐžÐ›Ð¬ÐšÐž ÐµÑÐ»Ð¸ CI ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ð»ÑÑ!
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: ðŸš€ Deploy to Server
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "=========================================="
            echo "ðŸš€ Ð”Ð•ÐŸÐ›ÐžÐ™ TELEGRAM CHESS BOT"
            echo "Ð¡ÐµÑ€Ð²ÐµÑ€: 45.144.67.232"
            echo "ÐŸÐ¾Ñ€Ñ‚: 8081"
            echo "=========================================="
            
            # 1. ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
            cd /opt/telegram-chess-bot
            
            # 2. ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹
            echo "ðŸ›‘ ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²..."
            docker stop telegram-chess-bot 2>/dev/null || true
            docker rm telegram-chess-bot 2>/dev/null || true
            docker stop telegram-bot-postgres 2>/dev/null || true
            docker rm telegram-bot-postgres 2>/dev/null || true
            
            # 3. Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹
            docker rmi telegram-chess-bot:latest 2>/dev/null || true
            
            # 4. Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼/Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð´ (ÐµÑÐ»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ git)
            # git pull origin main  # ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾
            
            # 5. Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ JAR (ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾ ÑÐ¾Ð±Ð¸Ñ€Ð°Ñ‚ÑŒ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ)
            # mvn clean package -DskipTests  # ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾
            
            # 6. Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Dockerfile
            cat > Dockerfile << 'EOF'
            FROM eclipse-temurin:17-jre
            WORKDIR /app
            COPY target/*.jar app.jar
            EXPOSE 8081
            ENTRYPOINT ["java", "-jar", "app.jar", "--server.port=8081", "--server.address=0.0.0.0"]
            EOF
            
            # 7. Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ PostgreSQL ÐµÑÐ»Ð¸ Ð½Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½
            if ! docker ps --format "{{.Names}}" | grep -q "telegram-bot-postgres"; then
              echo "ðŸ˜ Ð—Ð°Ð¿ÑƒÑÐº PostgreSQL..."
              docker run -d \
                --name telegram-bot-postgres \
                -e POSTGRES_DB=chessbot_db \
                -e POSTGRES_USER=postgres \
                -e POSTGRES_PASSWORD=postgres \
                -p 5433:5432 \
                --restart unless-stopped \
                postgres:16-alpine
              sleep 10
            fi
            
            # 8. Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð±Ð¾Ñ‚Ð°
            echo "ðŸ¤– Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¸ Ð·Ð°Ð¿ÑƒÑÐº Telegram Bot..."
            docker build -t telegram-chess-bot:latest .
            
            docker run -d \
              --name telegram-chess-bot \
              --restart unless-stopped \
              -p 8081:8081 \
              -e TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}" \
              -e TELEGRAM_BOT_USERNAME="${{ secrets.TELEGRAM_BOT_USERNAME }}" \
              telegram-chess-bot:latest
            
            # 9. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼
            echo "âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ°..."
            sleep 5
            
            echo "=== Ð¡Ð¢ÐÐ¢Ð£Ð¡ ÐšÐžÐÐ¢Ð•Ð™ÐÐ•Ð ÐžÐ’ ==="
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            
            echo ""
            echo "=== Ð”ÐžÐ¡Ð¢Ð£ÐŸÐÐ«Ð• ÐŸÐ Ð˜Ð›ÐžÐ–Ð•ÐÐ˜Ð¯ ==="
            echo "ðŸŽ® Chess API: http://45.144.67.232:8080"
            echo "ðŸ¤– Telegram Bot: http://45.144.67.232:8081"
            echo "ðŸ’¾ PostgreSQL Ð´Ð»Ñ Ð±Ð¾Ñ‚Ð°: Ð¿Ð¾Ñ€Ñ‚ 5433"
            
            echo "=========================================="
            echo "ðŸŽ‰ TELEGRAM BOT Ð£Ð¡ÐŸÐ•Ð¨ÐÐž Ð—ÐÐŸÐ£Ð©Ð•Ð!"
            echo "=========================================="